1. ### 1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

      > SV39 页表项由 PPN 和 Flags 两部分组成：
      >
      > - 44 位 PPN 域：用于描述页表项的物理页号。如果该页表项是叶节点，PPN 表示物理地址的一部分；如果不是叶节点，则 PPN 给出下一页表的地址。
      > - 2 位 RSW 域：为操作系统保留使用，硬件会忽略该域。可用来自定义状态或标志。
      > - R/W/X/U 权限位：分别表示该页表项的可读、可写、可执行和是否为用户态权限。这些位控制页面的访问权限，提升系统的隔离性和安全性。如果 R/W/X 均为 0，则该页表项指向下一级页表，否则为叶节点。U 位则控制页表项的特权级访问，U=0 表示只允许在 S 模式下访问，U=1 表示只能在 U 模式下访问。
      > - V/G 有效位：V 位表示页表项是否有效，无效则任何访问该虚拟地址的操作将触发页错误。G 位用于优化操作系统页面的虚地址转换过程。
      > - A/D 脏位：表示页面是否已被访问或修改，有助于页面置换算法减少不必要的写回操作。

   ### 2. 缺页
      缺页指的是进程访问页面时页面不在页表中或在页表中无效的现象，此时 MMU 将会返回一个中断， 告知 os 进程内存访问出了问题。os 选择填补页表并重新执行异常指令或者杀死进程。

      - **请问哪些异常可能是缺页导致的？**

        > 缺页可能导致页错误（当虚拟内存页面对应的物理页不在内存中）、访存异常（访问不存在的页面）、页保护异常（访问页面时权限不足）、TLB 未命中（在 TLB 中未找到对应的页表项）。

      - **发生缺页时，相关重要寄存器的值是什么？**

        > `satp` 存储根页表的物理地址；`scause` 保存异常原因；`stval` 保存引发异常的虚拟地址；`sstatus` 保存当前 CPU 状态。

      缺页常见的原因之一是 Lazy 策略，即直到页面被实际访问时才进行页表操作。比如程序执行时，理论上进程的代码段需要从磁盘加载到内存。但操作系统不会立刻加载，而是保存 `.text` 段在磁盘的位置信息，在代码第一次执行时才加载。

      - **这样做有哪些好处？**

        > 只加载实际访问的部分，提高了内存使用效率；减少系统启动时间，避免不必要的磁盘读取和内存占用，有效提升内存利用率和减少碎片。

      `mmap` 也可采用 Lazy 策略。例如，当用户进程申请了 10G 内存，仅使用了 1M 后就退出，现有的做法就会浪费大量资源进行不必要的页表操作。

      - **处理 10G 连续的内存页面对应的 SV39 页表大致占用多少内存？**

        > SV39 页表页大小为 4KiB，每项占 8 字节，对应 10G 连续内存的 SV39 页表大致占用 32MiB。

      - **如何实现 Lazy 策略？缺页时又如何处理？**

        > 初始阶段仅分配虚拟空间，等用户访问页面触发缺页异常，交给内核异常处理后再进行物理页面分配和更新页表项，然后将控制权交回用户继续执行。

      缺页的另一常见原因是 Swap 策略，即内存页面可能被换出至磁盘，导致页面失效。

      - **页面失效如何在页表项 (PTE) 上体现？**

        > V 位为 0 表示页表项无效。

   ### 3. 双页表与单页表

      操作系统使用双页表来防范侧信道攻击。传统设计通常采用单页表，即用户线程和对应的内核线程共用一张页表，只是在内核态才能访问内核地址。（注：此处的单/双页表是通俗说法，详情请参考 [KPTI](https://en.wikipedia.org/wiki/Kernel_page-table_isolation)）

      - **单页表情况下如何更换页表？**

        > 更换页表时通过更新 `satp` 寄存器的值。

        **如何控制用户态无法访问内核页面？**

        > 通过设置 U 位为 0，以此限制用户态访问内核页面。

        **单页表的优势是什么？**

        > 相较双页表更为简单，避免了系统调用时频繁切换页表带来的性能损失。

        **双页表情况下何时更换页表？单页表设计下你会选择何时更换页表？**

        > 双页表设计在 trap 和任务切换时需要更换页表；单页表设计中则在任务切换时更换页表。

        **CPU 产生 page fault 异常时，操作系统如何判断应加载外存中的页面内容，而不是处理非法访问异常？**

        > 操作系统会检查页表项及相关标志位，若页表项无效但标志表明页面被换出，则需要从外存加载页面；若是其他异常情况则需执行非法访问处理。


